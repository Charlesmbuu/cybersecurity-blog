# Exploiting server-side parameter pollution in a query string

<!-- insert image related on the topic-->
![server-7239721_1280](https://github.com/user-attachments/assets/3c344bee-7ea7-42e8-a4d2-2030306b72a2)

---

## Introduction

Server-side parameter pollution occurs when a website embeds user input in a server-side request to an internal API without adequate encoding. 

This means that an attacker may be able to manipulate or inject parameters, which may enable them to: (for example)
  - Override existing parameters.
  - Modify the application.
  - Access unauthorized data.


Any user input can be tested for any kind of parameter pollution, for example:
  - query parameters,
  - form fields,
  - headers,
  - URL path parameters.

### NOTE:
> This vulnerability is sometimes called HTTP parameter pollution.
> But this term is also used to refer to a web application firewall (WAF) bypass technique.
> This vulnerability class has very little in common with server-side prototype pollution.

---

## Objective

To solve this lab, we are to:
  - Login as the `administrator`
  -  delete `Carlos`.

> Required Knowledge
- How to use URL query syntax to attempt to change a server-side request.
- How to use errir messages to build an understanding of how a server-side API processes user input.

---

## Methodology

With no `administrator` credentials to use, here's how we can solve this lab:
---

> Step 1

 *Password Reset*

- In Burp's browser, trigger a password reset for the administrator user.

<img width="960" alt="Screenshot 2025-03-10 181104" src="https://github.com/user-attachments/assets/3bdc0f41-6f1f-4973-bedd-7fd00abf5fce" />

---

> Step 2

*View the Different Requests Triggered*

- Head over to Proxy > HTTP history.
- Here you'll notice the **`POST` `/forgot-password`** request and the related **`/static/js/forgotPassword.js`** JavaScript file.
  
<img width="954" alt="Screenshot 2025-03-10 181235" src="https://github.com/user-attachments/assets/aca815c5-d230-4de8-91e3-28d270931129" />

---

> Step 3

*Send `POST` `/forgot-password` to Repeater [crl+R] for Further Diagnosis and Investigation*.

- Right-click the POST /forgot-password request and select *`Send to Repeater`*.
  
<img width="954" alt="Screenshot 2025-03-10 181235" src="https://github.com/user-attachments/assets/5fb6b951-cf25-457a-8093-3d7f89892e58" />

---

> Step 4

***Send** the Original Request Without Altering Anything in the REQUEST*

- In the Repeater tab, resend the request to confirm that the response is consistent.
  
<img width="640" alt="Screenshot 2025-03-10 181401" src="https://github.com/user-attachments/assets/d7bd9dc9-3613-41d8-99e7-64fb717728f5" />

---

> Step 5

*Carry out an Obvious Invalid REQUEST*

- Change the value of the username parameter from administrator to an invalid username, such as `administratorx`.
- Send the request.
- Notice that this results: **`Invalid username error message`**.
  
<img width="638" alt="Screenshot 2025-03-10 181529" src="https://github.com/user-attachments/assets/1e29a4c3-11c8-4ef1-915d-5cacad98c63c" />

---

> Step 6

*Alter the Request Further with Different Approaches[URL Encoding]*

### APPROACH 1 
> Addition.

- Attempt to add a second parameter-value pair to the server-side request using a URL-encoded & character.
- For example, we will add `&x=y`, but it needs to be URL-encoded.
- Hence the request should read:
  
  ```
  username=administrator%26x=y
  ```
  
<img width="638" alt="Screenshot 2025-03-10 181616" src="https://github.com/user-attachments/assets/12552f24-0085-40f3-94c7-791922560df7" />

---

- **Send** the request.
- Notice that this returns:  **`Parameter is not supported error message`**.
- This suggests that the internal API may have interpreted `&x=y` as a separate parameter, instead of part of the *username*.
  
<img width="638" alt="Screenshot 2025-03-10 181616" src="https://github.com/user-attachments/assets/8027cd90-82cc-4d46-bae0-52d39cd0333d" />

---

### APPROACH 2
> TRUNCATION

- Attempt to truncate the server-side query string using a URL-encoded `#` character:
  
```
username=administrator%23
```

- **Send** the request.
- Notice that this returns: **`Field not specified error message`**.
- This suggests that the server-side query may include an additional parameter called *`Field`*, which has been removed by the `#` character.
  
<img width="640" alt="Screenshot 2025-03-10 181717" src="https://github.com/user-attachments/assets/1584be76-12c0-4b82-a27c-cf631dd9b63c" />

---

> Step 7

*Play with the Field Parameter*

- Add a field parameter with an invalid value to the request.
- Truncate the query string after the added parameter-value pair.
- For example, add URL-encoded `&field=x#` to read:

```
username=administrator%26field=x%23
```

- **Send** the request.

<img width="666" alt="Screenshot 2025-03-10 181908" src="https://github.com/user-attachments/assets/1ec676b5-a1e4-41f6-9815-62a35f9bfba3" />

- Notice that this results: **`Invalid field error message`**
- This suggests that the server-side application may recognize the injected field parameter.

---

> Step 8

*Brute-force the value of the field parameter*

- Right-click the `POST` `/forgot-password` request and select Send to Intruder.
- In the Intruder tab, add a payload position to the value of the field parameter(`x`) as follows to read out as:
  
```
username=administrator%26field=¬ßx¬ß%23
```

<img width="667" alt="Screenshot 2025-03-10 182201" src="https://github.com/user-attachments/assets/e3ccfe8a-0eaa-4141-9666-390497dbe557" />

---

- In the Payloads side panel, under Payload configuration, click Add from list.
- If you have a custom `server-side_variable_names_payload_list.pay`, you can **Load** it from your local computer.
- For *Pro-Edition*; Select the built-in Server-side variable names payload list.
- **start the attack**.

<img width="589" alt="Screenshot 2025-03-10 182137" src="https://github.com/user-attachments/assets/f9b77c5a-a0ab-48c7-b94e-7c6d3c445dbc" />

---

> Step 9

*Review the Results* 

- Notice that the requests with the `username` and `email` payloads both return a **200 response**.
- Change the value of the field parameter from `x#` to `email` so as to read out:

```
username=administrator%26field=email%23
```

<img width="951" alt="Screenshot 2025-03-10 182315" src="https://github.com/user-attachments/assets/a9b5ebec-2a26-4bc5-a1e7-b61530391a66" />

---

- **Send** the request.
- Notice that this returns the original response.
- This suggests that email is a valid field type.

---

> Step 10

*More Reconnaisance*

- In Proxy > HTTP history, review the `/static/js/forgotPassword.js` JavaScript file.
- Notice the *password reset endpoint*, which refers to the *reset_token parameter*:

```
/forgot-password?reset_token=${resetToken}
```

- This is what comes after the website's URL so that the password reset can take place.

<img width="668" alt="Screenshot 2025-03-10 182435" src="https://github.com/user-attachments/assets/55ba4b5a-366f-4fea-a31f-c1c2a5b9ee2d" />

---

> Step 11

*Back to `POST` `/forgot-password` Request*

- In the Repeater tab, change the value of the field parameter from `email` to `reset_token` without forgetting the URL-encoded truncation at the end:

```
username=administrator%26field=reset_token%23
```

<img width="736" alt="Screenshot 2025-03-10 182602" src="https://github.com/user-attachments/assets/b73784ed-5668-4610-ad9b-4b1aaba107e6" />

- **Send** the request.
- Notice that this returns a password reset token.
- Note it down. This token is the one we will use to curve out the `URL address`.

  > For my case, below was my token:
  
<img width="303" alt="Screenshot 2025-03-10 182640" src="https://github.com/user-attachments/assets/eed1a10f-b2ca-4476-9e85-3de3ef2d4cf1" />

---

>Step 12

*Generate the URL*

- In Burp's browser, enter the password reset endpoint in the address bar.
- **Add** your password reset token as the value of the reset_token parameter.
- For example:

```
https://9fsef0seu3282b403u9327fb08.api.lab.com/forgot-password?reset_token=123456789
```

<img width="960" alt="Screenshot 2025-03-10 182824" src="https://github.com/user-attachments/assets/79fd1cc7-36c0-4c44-a6bd-909317e69013" />

---

> Step 13

*Reset the Password*

- Set a new password, now that we have gained access.
  
<img width="862" alt="Screenshot 2025-03-10 182927" src="https://github.com/user-attachments/assets/2cc8e28d-405a-467f-8ac1-81bbcf528462" />

---

> Step 14

*Log in*

- Log in as the `administrator` user using your *new password*.
  
<img width="523" alt="Screenshot 2025-03-10 183057" src="https://github.com/user-attachments/assets/af47e275-d8bd-4d17-a1c6-609e307c5344" />

---

> Step 15

 
- Go to the **Admin panel** and ‚ùå**`Delete carlos`**‚ùå.

<img width="520" alt="Screenshot 2025-03-10 183137" src="https://github.com/user-attachments/assets/a31bca8b-56a9-45b8-a1c7-7e8a23a03991" />

- üåü Congrats! üòÅ

   **LAB SOLVED!**
  
<img width="524" alt="Screenshot 2025-03-10 183153" src="https://github.com/user-attachments/assets/df85d0ec-1c16-4e75-9e3a-e45da9ca9f4b" />
